---
name: Create OpenAPI specification for MVP endpoints
status: open
created: 2025-10-15T03:50:56Z
updated: 2025-10-15T04:04:35Z
github: https://github.com/lorenzotomasdiez/ArcAPI/issues/4
depends_on: [2, 3]
parallel: false
conflicts_with: []
---

# Task: Create OpenAPI Specification for MVP Endpoints

## Description

Create a comprehensive OpenAPI 3.1 specification for all ARCA API MVP endpoints. This spec serves as the **executable contract** between frontend, backend, and SDK teams, enabling parallel development.

Leverage the **complete OpenAPI template** from the PRD (lines 1050-1242) - it already defines the structure, authentication, error handling (RFC 7807), and example schemas. Our job is to customize it with ARCA API-specific endpoints from the product PRD.

**Critical for:** Spec-driven development, frontend/backend parallelization, SDK generation, API documentation.

## Acceptance Criteria

- [ ] `docs/specifications/api/openapi.yaml` created with valid OpenAPI 3.1 format
- [ ] All MVP endpoints documented (invoices, certificates, reference data)
- [ ] Authentication specified (Bearer token with API key)
- [ ] Rate limiting documented per tier (100 req/min free, 1000 req/min pro)
- [ ] Error responses follow RFC 7807 Problem Details format
- [ ] Request/response schemas complete with examples for each endpoint
- [ ] OpenAPI spec validates with Spectral (zero errors)
- [ ] Spec includes 2 servers: production (`api.arcaapi.com/v1`) and sandbox (`sandbox.arcaapi.com/v1`)
- [ ] All endpoints tagged for logical grouping (Invoices, Certificates, Reference Data)
- [ ] Versioning strategy documented (URL-based /v1/)

## Technical Details

### MVP Endpoints to Document

Based on product PRD Phase 1 requirements:

#### **1. Invoices**
- `POST /invoices` - Create invoice (simple mode + advanced mode)
  - Simple mode: Natural language description → AI generates structure
  - Advanced mode: Full structured invoice data
- `GET /invoices/:id` - Get invoice by ID
- `GET /invoices` - List invoices with pagination, filters
- `PATCH /invoices/:id` - Update invoice (before submission to ARCA)

#### **2. Certificates**
- `POST /certificates` - Upload ARCA certificate (.pfx file)
- `GET /certificates` - List user's certificates
- `DELETE /certificates/:id` - Delete certificate

#### **3. Reference Data**
- `GET /reference-data/invoice-types` - ARCA invoice types (Factura A, B, C, etc.)
- `GET /reference-data/iva-rates` - IVA rates and codes
- `GET /reference-data/document-types` - Document type codes (CUIT, DNI, etc.)
- `GET /reference-data/currencies` - Supported currencies
- `GET /reference-data/sales-points` - Available sales point numbers

#### **4. API Keys (Account Management)**
- `POST /api-keys` - Create new API key
- `GET /api-keys` - List API keys (hashed, show prefix only)
- `DELETE /api-keys/:id` - Revoke API key

### OpenAPI Template Structure (from PRD)

```yaml
openapi: 3.1.0
info:
  title: ARCA API
  version: 1.0.0
  description: |
    Electronic invoicing API for Argentina (ARCA/AFIP).
    [Authentication, rate limiting, error format documentation]
  contact:
    email: support@arcaapi.com
  license:
    name: MIT

servers:
  - url: https://api.arcaapi.com/v1
    description: Production
  - url: https://sandbox.arcaapi.com/v1
    description: Sandbox (test ARCA homologación environment)

security:
  - BearerAuth: []

paths:
  /invoices:
    post:
      summary: Create invoice
      description: [Detailed description of simple vs advanced mode]
      operationId: createInvoice
      tags: [Invoices]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/SimpleInvoiceRequest'
                - $ref: '#/components/schemas/AdvancedInvoiceRequest'
            examples:
              simple: [example]
              advanced: [example]
      responses:
        '201': [Invoice created]
        '400': [Validation error]
        '401': [Unauthorized]
        '429': [Rate limited]
        '500': [Internal error]

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key

  schemas:
    SimpleInvoiceRequest: [schema]
    AdvancedInvoiceRequest: [schema]
    Invoice: [schema]
    ProblemDetails: [RFC 7807 error format]

  responses:
    BadRequest: [400 error template]
    Unauthorized: [401 error template]
    RateLimited: [429 error template]
    InternalError: [500 error template]
```

### Key Schema Definitions Needed

**SimpleInvoiceRequest** (AI mode):
```yaml
type: object
required: [mode, description]
properties:
  mode:
    type: string
    enum: [simple]
  description:
    type: string
    minLength: 10
    maxLength: 1000
    description: Natural language invoice description
    example: "Factura para Juan Pérez por 3 horas de consultoría a $5000/hora"
```

**AdvancedInvoiceRequest** (structured mode):
```yaml
type: object
required: [mode, tipo_comprobante, punto_venta, cliente, items]
properties:
  mode:
    type: string
    enum: [advanced]
  tipo_comprobante:
    type: integer
    description: ARCA invoice type code
    enum: [1, 6, 11]  # Factura A, B, C
  punto_venta:
    type: integer
    description: Sales point number
  cliente:
    $ref: '#/components/schemas/Cliente'
  items:
    type: array
    items:
      $ref: '#/components/schemas/InvoiceItem'
```

**Invoice** (response):
```yaml
type: object
properties:
  id:
    type: string
    format: uuid
  numero:
    type: integer
    description: Invoice number assigned by ARCA
  cae:
    type: string
    description: Electronic authorization code from ARCA
  vencimiento_cae:
    type: string
    format: date
  status:
    type: string
    enum: [pending, approved, failed, pending_retry]
  # ... [additional fields from product PRD schema]
```

**ProblemDetails** (RFC 7807 error format):
```yaml
type: object
description: RFC 7807 Problem Details for HTTP APIs
required: [type, title, status]
properties:
  type:
    type: string
    format: uri
    description: URI reference identifying the problem type
  title:
    type: string
    description: Short, human-readable summary
  status:
    type: integer
    description: HTTP status code
  detail:
    type: string
    description: Human-readable explanation
  instance:
    type: string
    description: URI reference for this specific occurrence
  errors:
    type: array
    description: Validation errors
    items:
      type: object
      properties:
        field:
          type: string
        message:
          type: string
```

### Implementation Approach

1. **Copy PRD OpenAPI template** (lines 1050-1242) → `docs/specifications/api/openapi.yaml`
2. **Customize metadata** (title, description, servers, contact)
3. **Define authentication** (BearerAuth, API key format)
4. **Add invoice endpoints** (POST, GET, PATCH) with full schemas
5. **Add certificate endpoints** (POST, GET, DELETE)
6. **Add reference data endpoints** (all GET, simple responses)
7. **Define error responses** (RFC 7807 for all 4xx/5xx)
8. **Add examples** for each request/response (copy from product PRD user stories)
9. **Validate with Spectral** (`npx @stoplight/spectral-cli lint openapi.yaml`)
10. **Generate HTML docs** (Swagger UI or Redocly for preview)

### Validation & Quality Checks

**Spectral Linting Rules**:
- No undefined schemas
- All paths have operationId
- All operations have tags
- Examples match schemas
- No orphaned components
- Consistent naming (camelCase vs snake_case)

**Manual Checks**:
- Every endpoint has description
- Rate limiting specified in info section
- Authentication requirements clear
- Error responses consistent (all use ProblemDetails)
- Pagination documented for list endpoints

### Files Affected

- Create: `docs/specifications/api/openapi.yaml` (main deliverable)
- Create: `docs/specifications/api/README.md` (how to use spec, validation commands)
- Update: `docs/specifications/README.md` (link to API spec)

## Dependencies

**Depends On:**
- Task 001 (needs `specifications/api/` directory)
- Task 002 (needs authentication decisions from ADR-002)

**Blocks:**
- Task 008 (CI validation needs spec to exist)
- Frontend development (can mock API from spec)
- Backend development (can generate stubs from spec)
- SDK development (can auto-generate client code)

**External:**
- Product PRD (source of endpoints and schemas) ✅ Available
- OpenAPI tooling (Spectral, Swagger UI) ✅ Available

## Effort Estimate

- **Size**: M
- **Hours**: 12-16 hours over 2 days
- **Parallel**: false (blocks frontend/backend/SDK work)
- **Breakdown**:
  - Template customization (metadata, auth): 1 hour
  - Invoice endpoints + schemas: 4 hours
  - Certificate endpoints: 1.5 hours
  - Reference data endpoints: 1.5 hours
  - API key management endpoints: 1 hour
  - Error response schemas (RFC 7807): 1 hour
  - Examples for all endpoints: 2 hours
  - Validation with Spectral and fixes: 1 hour
  - Documentation (README, usage guide): 1 hour

## Definition of Done

- [ ] `openapi.yaml` created with all MVP endpoints
- [ ] OpenAPI 3.1 format validated (Spectral reports 0 errors)
- [ ] All endpoints have operationId, tags, summary, description
- [ ] Request/response schemas complete with required fields marked
- [ ] Examples provided for all request/response combinations
- [ ] Error responses standardized (RFC 7807 Problem Details)
- [ ] Authentication documented (Bearer token format, where to get API key)
- [ ] Rate limiting specified in API description
- [ ] Pagination documented for list endpoints (limit, offset, total)
- [ ] Servers configured (production + sandbox)
- [ ] Generated HTML documentation previewed (Swagger UI or Redocly)
- [ ] README created explaining how to validate spec and generate docs
- [ ] Peer review completed (frontend/backend engineers verify spec meets their needs)
- [ ] Spec committed to Git

## Notes

**Why this is critical:**
- **Enables parallel development**: Frontend can mock, backend can implement independently
- **Contract testing**: API implementation validated against spec in CI
- **SDK generation**: Auto-generate client libraries from spec (saves weeks)
- **Documentation**: Spec becomes interactive API docs (Swagger UI, Redocly)

**Template Leverage:**
- PRD provides 200+ lines of OpenAPI template - don't start from scratch!
- Error response format (RFC 7807) fully specified in PRD - copy it

**Success Indicator:**
- Frontend engineer can build UI without waiting for backend (using spec to mock)
- Backend engineer can generate API stubs from spec (using openapi-generator)

**Validation Commands:**
```bash
# Validate spec
npx @stoplight/spectral-cli lint docs/specifications/api/openapi.yaml

# Generate HTML docs
npx @redocly/cli build-docs docs/specifications/api/openapi.yaml -o docs/api.html

# Serve interactive docs locally
npx @redocly/cli preview-docs docs/specifications/api/openapi.yaml
```

**References:**
- PRD Section: "API Specification Template (OpenAPI)" (lines 1050-1242)
- Product PRD: Database schema (has complete invoice field definitions)
- OpenAPI 3.1 Spec: https://spec.openapis.org/oas/v3.1.0
- RFC 7807 Problem Details: https://datatracker.ietf.org/doc/html/rfc7807
