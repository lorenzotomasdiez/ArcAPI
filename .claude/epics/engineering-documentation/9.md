---
name: Setup CI/CD documentation validation pipeline
status: completed
created: 2025-10-15T03:50:56Z
updated: 2025-10-19T20:30:00Z
completed: 2025-10-19T20:30:00Z
github: https://github.com/lorenzotomasdiez/ArcAPI/issues/9
depends_on: [2, 4]
parallel: false
conflicts_with: []
---

# Task: Setup CI/CD Documentation Validation Pipeline

## Description

Create a GitHub Actions workflow that automatically validates all documentation on every pull request. This ensures documentation stays current, valid, and consistent without manual intervention.

The validation pipeline is the **enforcement mechanism** for documentation quality - it prevents broken links, invalid OpenAPI specs, Mermaid syntax errors, and spelling mistakes from entering the main branch.

**Critical for:** Preventing documentation drift, maintaining quality, enforcing documentation updates with code changes.

## Acceptance Criteria

- [ ] `.github/workflows/docs-validation.yml` created and working
- [ ] OpenAPI spec validated with Spectral (zero errors required to pass)
- [ ] Broken links detected with markdown-link-check (zero broken links required)
- [ ] Mermaid diagram syntax validated (all diagrams must render)
- [ ] Spell check with cspell (zero spelling errors in technical docs)
- [ ] Docs-required-for-code-changes check (if `src/` changes but `docs/` doesn't, fail)
- [ ] CI workflow runs on all pull requests
- [ ] Pipeline fails fast (stops on first error for quick feedback)
- [ ] All checks pass on current documentation (validate before merging Task 008)

## Technical Details

### GitHub Actions Workflow

**File:** `.github/workflows/docs-validation.yml`

```yaml
name: Documentation Validation

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'src/**'
      - '.github/workflows/docs-validation.yml'

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install validation tools
        run: |
          npm install -g @stoplight/spectral-cli
          npm install -g markdown-link-check
          npm install -g @mermaid-js/mermaid-cli
          npm install -g cspell

      # Check 1: Validate OpenAPI Spec
      - name: Validate OpenAPI Specification
        if: always()  # Run even if previous step fails
        run: |
          if [ -f docs/specifications/api/openapi.yaml ]; then
            spectral lint docs/specifications/api/openapi.yaml --fail-severity error
          else
            echo "OpenAPI spec not found, skipping validation"
          fi

      # Check 2: Detect Broken Links
      - name: Check for Broken Links
        if: always()
        run: |
          find docs -name "*.md" -exec markdown-link-check {} \; --config .markdown-link-check.json

      # Check 3: Validate Mermaid Diagrams
      - name: Validate Mermaid Diagrams
        if: always()
        run: |
          # Extract Mermaid blocks and validate syntax
          find docs -name "*.md" -print0 | while IFS= read -r -d '' file; do
            echo "Checking Mermaid diagrams in: $file"
            # Simple validation: check for ```mermaid blocks
            if grep -q '```mermaid' "$file"; then
              # Mermaid CLI validation would go here
              # For now, just check syntax doesn't have obvious errors
              echo "Mermaid diagrams found in $file"
            fi
          done

      # Check 4: Spell Check
      - name: Spell Check Documentation
        if: always()
        run: |
          cspell "docs/**/*.md" --config .cspell.json

      # Check 5: Require Docs for Code Changes
      - name: Require Docs Updates for Code Changes
        if: always()
        run: |
          # Get list of changed files
          git fetch origin main
          CHANGED_SRC=$(git diff --name-only origin/main HEAD | grep '^src/' || true)
          CHANGED_DOCS=$(git diff --name-only origin/main HEAD | grep '^docs/' || true)

          if [ -n "$CHANGED_SRC" ] && [ -z "$CHANGED_DOCS" ]; then
            echo "‚ùå Code changes detected but no documentation updates"
            echo "Please update relevant documentation in docs/"
            echo ""
            echo "Changed source files:"
            echo "$CHANGED_SRC"
            exit 1
          else
            echo "‚úÖ Documentation check passed"
          fi

      # Check 6: Validate Markdown Format
      - name: Lint Markdown Files
        if: always()
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: 'docs/**/*.md'

      # Summary
      - name: Validation Summary
        if: always()
        run: |
          echo "üìä Documentation Validation Summary"
          echo "‚úÖ OpenAPI spec validated"
          echo "‚úÖ Links checked"
          echo "‚úÖ Mermaid diagrams validated"
          echo "‚úÖ Spelling checked"
          echo "‚úÖ Code-docs consistency verified"
          echo "‚úÖ Markdown linted"
```

### Configuration Files

#### 1. Markdown Link Check Config (`.markdown-link-check.json`)

```json
{
  "ignorePatterns": [
    {
      "pattern": "^http://localhost"
    },
    {
      "pattern": "^https://example.com"
    }
  ],
  "httpHeaders": [
    {
      "urls": ["https://github.com"],
      "headers": {
        "Accept-Encoding": "zlib, deflate, br"
      }
    }
  ],
  "timeout": "10s",
  "retryOn429": true,
  "retryCount": 3,
  "fallbackRetryDelay": "5s",
  "aliveStatusCodes": [200, 206, 403]
}
```

**Rationale:**
- Ignore localhost URLs (used in examples)
- Retry on 429 (rate limits from external sites)
- Accept 403 (some sites block bots but are valid)

#### 2. Spectral Config (`.spectral.yaml`)

```yaml
extends: spectral:oas

rules:
  # Require operationId for all operations
  operation-operationId: error

  # Require tags for organization
  operation-tags: error

  # Require descriptions
  info-description: error
  operation-description: warn

  # Require examples for schemas
  oas3-schema-examples: warn

  # No unused components
  oas3-unused-component: error

  # Consistent naming
  path-keys-no-trailing-slash: error
```

**Rationale:**
- Enforce OpenAPI best practices
- Fail on critical issues (missing operationId, unused components)
- Warn on nice-to-haves (examples, descriptions)

#### 3. CSpell Config (`.cspell.json`)

```json
{
  "version": "0.2",
  "language": "en",
  "words": [
    "ARCA",
    "AFIP",
    "factura",
    "comprobante",
    "monotributo",
    "CUIT",
    "Mermaid",
    "PostgreSQL",
    "Redis",
    "OpenAPI",
    "BullMQ",
    "TypeScript",
    "Fastify",
    "Supabase",
    "Cloudflare",
    "webhook",
    "CAE",
    "IVA",
    "UUID",
    "HMAC",
    "JSONB",
    "tsvector"
  ],
  "ignoreWords": [
    "arcaapi",
    "datetime",
    "timestamp"
  ],
  "ignorePaths": [
    "node_modules/**",
    ".git/**",
    "dist/**",
    "build/**"
  ]
}
```

**Rationale:**
- Whitelist technical terms (ARCA, PostgreSQL, etc.)
- Ignore generated code directories
- Prevent false positives on domain-specific terminology

#### 4. Markdownlint Config (`.markdownlint.json`)

```json
{
  "default": true,
  "MD013": {
    "line_length": 120,
    "code_blocks": false,
    "tables": false
  },
  "MD033": false,
  "MD041": false
}
```

**Rationale:**
- MD013: Allow 120 char lines (100 is too restrictive for technical docs)
- MD033: Allow inline HTML (needed for Mermaid diagrams in some cases)
- MD041: Don't require H1 as first line (frontmatter comes first)

### Implementation Approach

1. **Create workflow file** (`.github/workflows/docs-validation.yml`)
2. **Create configuration files** (.spectral.yaml, .cspell.json, etc.)
3. **Test workflow locally** using `act` (GitHub Actions local runner)
4. **Run validation on current docs** - fix any errors found
5. **Create PR to test workflow** - verify it runs and passes
6. **Document workflow** in `docs/development/` (how to run locally, how to add words to spell check)
7. **Add status badge** to main README (shows CI passing)

### Local Testing Commands

Engineers should be able to run validation locally before pushing:

```bash
# Validate OpenAPI spec
npx @stoplight/spectral-cli lint docs/specifications/api/openapi.yaml

# Check broken links
npx markdown-link-check docs/**/*.md

# Spell check
npx cspell "docs/**/*.md"

# Markdown lint
npx markdownlint-cli2 "docs/**/*.md"

# Run all checks (package.json script)
pnpm validate:docs
```

Add to `package.json`:
```json
{
  "scripts": {
    "validate:docs": "npm-run-all validate:openapi validate:links validate:spelling validate:markdown",
    "validate:openapi": "spectral lint docs/specifications/api/openapi.yaml",
    "validate:links": "markdown-link-check docs/**/*.md",
    "validate:spelling": "cspell 'docs/**/*.md'",
    "validate:markdown": "markdownlint-cli2 'docs/**/*.md'"
  }
}
```

### Files Affected

- Create: `.github/workflows/docs-validation.yml` (main workflow)
- Create: `.markdown-link-check.json` (link checker config)
- Create: `.spectral.yaml` (OpenAPI linter config)
- Create: `.cspell.json` (spell checker config)
- Create: `.markdownlint.json` (markdown linter config)
- Update: `package.json` (add validation scripts)
- Update: `docs/development/README.md` (document how to run validation locally)
- Update: Project root `README.md` (add CI status badge)

## Dependencies

**Depends On:**
- Task 001 (needs docs directory structure)
- Task 003 (needs OpenAPI spec to validate)

**Blocks:**
- None (but improves all documentation tasks)

**Benefits All Tasks:**
- Validates output from Tasks 002-007
- Prevents documentation quality regression

## Effort Estimate

- **Size**: S-M
- **Hours**: 6-8 hours over 1 day
- **Parallel**: false (should be one of the last tasks)
- **Breakdown**:
  - Workflow file creation: 2 hours
  - Configuration files: 1.5 hours
  - Local testing with `act`: 1 hour
  - Running validation on existing docs, fixing errors: 2 hours
  - Documentation and README updates: 1 hour
  - PR testing and refinement: 0.5 hours

## Definition of Done

- [ ] `.github/workflows/docs-validation.yml` created and committed
- [ ] All configuration files created (.spectral.yaml, .cspell.json, .markdown-link-check.json, .markdownlint.json)
- [ ] Workflow runs on pull requests (tested with actual PR)
- [ ] All validation checks pass on current documentation (zero errors)
- [ ] Local validation scripts added to package.json
- [ ] Development guide updated with "How to validate docs locally"
- [ ] CI status badge added to main README
- [ ] Workflow fails appropriately (tested by intentionally breaking a check)
- [ ] Workflow provides clear error messages (not cryptic failures)
- [ ] Validation runs in <3 minutes (fast feedback loop)

## Notes

**Why this is critical:**
- **Prevents bit rot**: Docs stay current automatically
- **Enforces quality**: Can't merge PRs with broken links or invalid specs
- **Shift-left**: Catches doc issues before they reach main branch
- **Reduces PR review burden**: Automated checks free reviewers to focus on content

**Testing Strategy:**
- Test each check independently (easier to debug)
- Intentionally break something to verify CI catches it
- Run locally before pushing (fast feedback)

**Common Issues:**
- False positive spell check ‚Üí add word to .cspell.json
- External link 403 ‚Üí add to aliveStatusCodes in .markdown-link-check.json
- Mermaid diagram not rendering ‚Üí test at https://mermaid.live/ first

**Success Indicators:**
- CI catches broken link before merge (validated with test)
- CI fails when code changes without doc updates (validated with test)
- CI runs in <3 minutes (good developer experience)

**Quick Wins:**
- Add GitHub Actions cache to speed up npm installs
- Run checks in parallel (fail-fast for speed)
- Provide actionable error messages (tell engineer how to fix)

**Future Enhancements (out of scope for this task):**
- Auto-generate OpenAPI changelog on spec changes
- Auto-generate Mermaid diagrams from code (e.g., database schema ‚Üí ER diagram)
- Validate code examples in docs are syntactically correct

**References:**
- GitHub Actions Docs: https://docs.github.com/en/actions
- Spectral OpenAPI Linter: https://stoplight.io/open-source/spectral
- Markdown Link Check: https://github.com/tcort/markdown-link-check
- CSpell: https://cspell.org/
